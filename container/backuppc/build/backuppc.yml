- hosts: localhost
  gather_facts: no
  become: yes

  vars:
    #couchpotato_git: https://github.com/RuudBurger/CouchPotatoServer.git

    config_url: ""
    config_user: ""
    config_pass: ""

    volume_uid: ""
    volume_gid: ""

    container_user:
      name: 'container'
      home: '/home/container'
      uid: '500'
      gid: '500'
      group: 'container'
      system: 'yes'
      shell: '/bin/bash'
      comment: 'container user'

    service_user:
      name: 'backuppc'
      home: '/home/backuppc'
      uid: '998'
      gid: '998'
      group: 'backuppc'
      system: 'yes'
      shell: '/bin/bash'
      comment: 'backuppc user'

# couchpotato_dirs:
#       - "{{service_user.home}}/cache"
#       - "{{service_user.home}}/custom_plugins"
#       - "{{service_user.home}}/database"
#       - "{{service_user.home}}/db_backup"
#       - "{{service_user.home}}/logs"

#     couchpotato_config: "{{service_user.home}}/settings.conf"

#     couchpotato_wc: "/opt/couchpotato"

    yumpackages:
      - git
      - sudo
      - backuppc
      - openssh-server

    sudoers:
      file: "/etc/sudoers.d/{{container_user.name}}"
      line: "{{container_user.name}} ALL=(ALL) NOPASSWD:ALL"

  tasks:
    - name: install yum packages
      yum:
        name={{item}}
        state=present
      with_items: "{{yumpackages}}"
      become: no
      tags:
        - setup

    - name: install sudoers file
      copy:
        content="{{sudoers.line}}"
        dest="{{sudoers.file}}"
      become: no
      tags:
        - setup

    - name: create container group
      group:
        name="{{container_user.group}}"
        gid="{{container_user.gid}}"
        system="{{container_user.system}}"
        state=present
      become: no
      tags:
        - setup

    - name: create container user
      user:
        name="{{container_user.name}}"
        home="{{container_user.home}}"
        uid="{{container_user.uid}}"
        group="{{container_user.group}}"
        shell="{{container_user.shell}}"
        system="{{container_user.system}}"
      become: no
      tags:
        - setup

    - name: create backuppc group
      group:
        name="{{service_user.group}}"
        gid="{{service_user.gid}}"
        system="{{service_user.system}}"
        state=present
      become: no
      tags:
        - setup

    - name: create backuppc daemon user
      user:
        name="{{service_user.name}}"
        home="{{service_user.home}}"
        uid="{{service_user.uid}}"
        group="{{service_user.group}}"
        shell="{{service_user.shell}}"
        system="{{service_user.system}}"
      become: no
      tags:
        - setup